<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Patterns of US rental prices</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel='icon' href='https://newmapsplus.github.io/favicon.ico' type='image/x-icon'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.css">
    <!-- Leaflet v1.7.1 style sheet: -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <!-- Custom fonts: -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Grand+Hotel&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
    <!-- CSS for this page: -->
    <link href="/lab-09/site-data/site.css" rel="stylesheet">
    <style>
        /* CSS overrides go in here */
    </style>
</head>

<body>
    <header>
        <h1>Mapping Patterns of US Rental Prices</h1>
        <h2>using Vanilla JavaScript</h2>
    </header>

    <div id='map'></div>
    <button id="info-button" onclick="myInfo()">Information</button>
    <div id='footer'>
        <div><img src="https://uky-gis.github.io/graphics/logo-color-400px.png" class="footer-img">
            <p>The average cost of rentals per county in the US.</p>
            <p>Map built with <a href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">Leaflet 1.7.1</a> using
                counties_median_rent_2015.json data file produced by joining data downloaded from <a
                    href="https://factfinder.census.gov/">American FactFinder</a> with US county polygons downloaded
                from the
                <a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html">US Census Cartographic
                    Boundary
                    Shapefiles</a>.</p>
            <p>Map created by Sirius T. Bontea, 20 March 2022.</p>
        </div>
    </div>
    <footer>
        <!-- <p>Map authored by YOUR NAME</p>
        <p>Additional information about the data and map goes here.</p>
        <p>And maybe, maybe, maybe... By now you should be quite happy about what's happening here. Steve wants
            reflections,
            so let's give him reflections. Let's put some happy trees and bushes back in here. We start with a vision in
            our
            heart, and we put it on canvas.

            Get away from those little Christmas tree things we used to make in school. It's a very cold picture, I may
            have
            to go get my coat. Itâ€™s about to freeze me to death. We tell people sometimes: we're like drug dealers, come
            into
            town and get everybody absolutely addicted to painting. It doesn't take much to get you addicted. We don't
            have to
            be committed. We are just playing here.
        </p> -->
    </footer>

    <!-- Load scripts using Subresource Integrity (SRI) is a security feature 
      that enables browsers to verify that resources they fetch (from a CDN) 
      are delivered without unexpected manipulation. -->
    <!-- Leaflet v1.7.1 script from https://leafletjs.com/ - Make sure this is placed this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
    <!-- jQuery v3.6.0 script from https://jquery.com/ -->
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> -->
    <!-- Simple Statistics v7.7.5 script from https://simplestatistics.org/ -->
    <script src="https://unpkg.com/simple-statistics@7.7.5/dist/simple-statistics.min.js"></script>
    <!-- Proj4js v2.8.0 script from https://cdnjs.com/libraries/proj4js/2.8.0 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"
        integrity="sha512-ha3Is9IgbEyIInSb+4S6IlEwpimz00N5J/dVLQFKhePkZ/HywIbxLeEu5w+hRjVBpbujTogNyT311tluwemy9w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Proj4Leaflet v1.0.2 script from https://cdnjs.com/libraries/proj4leaflet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.min.js"
        integrity="sha512-GsAYl1wxzWW6azVpXkhyYfjMb2LbaOnlrqWMBdAk9xDcilinFvGMN+48Ajp/10u/9lcnh8YyS2CYNgung7ewHg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Initial setup of basemap -->
    <script src="site-data/map.js"></script>


    <script>
        // MAKE AN AWESOME WEB MAP!
        fetch("data/counties_median_rent_2015.json")
            .then(function (response) {
                console.log(response)
                if (response.ok) {
                    return response.json()
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .then(function (data) {
                var data = L.geoJson(data, {
                    style: function (feature) {
                        return {
                            color: '#39352d',
                            weight: 0.6,
                            opacity: 0.7,
                            fillColor: 'tan',
                            fillOpacity: 0.8
                        }
                    },
                    onEachFeature: function (feature, layer) {
                        var p = layer.feature.properties
                        var popup = `<b>${p.NAME} County<br>Average rent: $${p.RENT}</b>`
                        layer.bindPopup(popup, {
                            direction: 'auto',
                            className: 'translucent-popup'
                        });
                        layer.bindTooltip(popup, {
                            className: 'translucent-tooltip',
                            direction: 'auto',
                        })
                    }
                }).addTo(map);
                drawMap(data)
            })
            .then(function () {
                drawNewLayers()
            })
            .catch(function (error) {
                console.log(`Something went wrong: ${error}`);
            });

        var additionLayers = {
            "data/us_states_20m.geojson": {
                color: '#39352d',
                weight: 2,
                opacity: 0.7,
                fillOpacity: 0,
                interactive: false
            }
        }

        function drawNewLayers() {
            for (newLayer in additionLayers) {
                fetch(newLayer)
                    .then(function (response) {
                        if (response.ok) {
                            return response.json()
                        }
                    })
                    .then(function (data) {
                        L.geoJson(data, {
                            style: function (feature) {
                                return additionLayers[newLayer]
                            }
                        }).addTo(map)
                    })
            }
        }

        function drawMap(data) {
            var breaks = getBreaks(data)
            data.eachLayer(function (layer) {
                var p = layer.feature.properties
                var rent = p.RENT
                var color = getColor(rent, breaks)
                layer.setStyle({
                    fillColor: color
                })
                layer.on('mouseover', function () {
                    layer.setStyle({
                        color: 'orange',
                        weight: 5,
                    })
                })
                layer.on('mouseout', function () {
                    layer.setStyle({
                        color: '#39352d',
                        weight: 0.6,
                    })
                })
            })
            drawLegend(breaks)
        }

        function calcRent(rent) {
            var rent = layer.feature.properties.RENT
            if (rent == null) {
                var rent = 'Data unavailable'
            } else {
                return rent
            }
        }

        ///////// clustered breaks /////////////
        function getBreaks(data) {
            var rentArray = [];
            data.eachLayer(function (layer) {
                var p = layer.feature.properties
                var rent = p.RENT
                if (rent != null) {
                    rentArray.push(rent)
                    // } else if (rent == null) {   // 
                    //     var rent = "Data Unavailable"
                    //     rentArray.push(rent)
                }
            });

            var clusters = ss.ckmeans(rentArray, 7);
            var breaks = clusters.map(function (cluster) {
                return [cluster[0], cluster.pop()];
            });
            rentArray.sort(function (a, b) {
                return a - b
            });
            console.log("rentArray", rentArray, "clusters", clusters, "breaks", breaks);
            console.log("breaks: [0][0]", breaks[0][0], "[0][1]", breaks[0][1]);
            console.log("breaks: [1][0]", breaks[1][0], "[1][1]", breaks[1][1]);
            console.log("breaks: [2][0]", breaks[2][0], "[2][1]", breaks[2][1]);
            console.log("breaks: [3][0]", breaks[3][0], "[3][1]", breaks[3][1]);
            console.log("breaks: [4][0]", breaks[4][0], "[4][1]", breaks[4][1]);
            console.log("breaks: [5][0]", breaks[5][0], "[5][1]", breaks[5][1]);
            console.log("breaks: [6][0]", breaks[6][0], "[6][1]", breaks[6][1]);
            return breaks
        }
        //// getColor function for the Legend and Counties.
        function getColor(d, breaks) {
            if (d >= breaks[0][0] && d <= breaks[0][1]) {
                return '#ffffcc'
            } else if (d >= breaks[1][0] && d <= breaks[1][1]) {
                return '#c7e9b4'
            } else if (d >= breaks[2][0] && d <= breaks[2][1]) {
                return '#7fcdbb'
            } else if (d >= breaks[3][0] && d <= breaks[3][1]) {
                return '#41b6c4'
            } else if (d >= breaks[4][0] && d <= breaks[4][1]) {
                return '#1d91c0'
            } else if (d >= breaks[5][0] && d <= breaks[5][1]) {
                return '#225ea8'
            } else if (d >= breaks[6][0] && d <= breaks[6][1]) {
                return '#0c2c84'
            } else {
                return '#1d91c0' // <-- This makes the legend "work", 
                // but I don't know why it behaves the way it does.
                // The $910 to $1104 bracket fails to colourise both the "legend"
                // and "counties" properly. It also colourises the "null" value inappropriately
                // The series of console.log entries above shows the brackets and as such, I've
                // tried to make the getColor function work.
                // Clearly, I'm smashing the square peg in the round hole, but I don't know
                // why it does this...
                // Ideally, I was wanting to colourise the returned "null" value as grey '#777777' 
                // with a note saying "Data unavailable" or something similar.
            }
        }

        function drawLegend(breaks) {
            var legend = L.control({
                position: 'topleft'
            });
            legend.onAdd = function () {
                var div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `<h3>Average Rent</h3>`;
                for (var i = 0; i < breaks.length; i++) {
                    var color = getColor(breaks[i][0], breaks);
                    div.innerHTML +=
                        `<span style="background:${color}"></span>
            <label>$${breaks[i][0]} &mdash;
            $${breaks[i][1]}</label>`;
                }
                return div;
            };
            legend.addTo(map);
        }

        /* --------------- Toggle on/off info footer content ---------------  */
        var clicked = false // start with false condition
        function myInfo() {

            // create button that changes color on click
            // create a footer overlay that displays 25% of the current viewport height
            var x = document.getElementById('footer');
            var y = document.getElementById('info-button');
            if (clicked) {
                y.style.background = 'rgba(107, 107, 107, 0.8)'; // gray button
                x.style.height = '0px'; // no footer height 
            } else {
                y.style.background = 'rgb(255, 165, 0, 0.8)' // orange button
                x.style.height = '25vh'; // footer 25% of viewport height
            }
            clicked = !clicked

        }
    </script>

</body>

</html>